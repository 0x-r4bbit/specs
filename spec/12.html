<h1 id="12ipfs-gateway-for-sticker-pack">12/IPFS gateway for Sticker Pack</h1>

<blockquote>
  <p>Version: 0.1.0</p>

  <p>Status: Draft</p>

  <p>Authors: Gheorghe Pinzaru <a href="mailto:gheorghe@status.im">gheorghe@status.im</a></p>

</blockquote>

<h2 id="table-of-contents">Table of Contents</h2>

<ol>
  <li><a href="#abstract">Abstract</a></li>
  <li><a href="#specification">Specification</a></li>
  <li><a href="#copyright">Copyright</a></li>
</ol>

<h2 id="abstract">Abstract</h2>

<p>This specification describes how Status uses the IPFS gateway to store stickers.
The specification explores image format, how a user uploads stickers and how an end user can see them inside the Status app.</p>

<h2 id="definition">Definition</h2>

<table>
  <thead>
    <tr>
      <th>Term</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Stickers</strong></td>
      <td>A set of images which can be used to express emotions</td>
    </tr>
    <tr>
      <td><strong>Sticker Pack</strong></td>
      <td>ERC721 token which includes the set of stickers</td>
    </tr>
    <tr>
      <td><strong>IPFS</strong></td>
      <td>P2P network used to store and share data, in this case, the images for the stickerpack</td>
    </tr>
  </tbody>
</table>

<h2 id="specification">Specification</h2>

<h3 id="image-format">Image format</h3>
<p>Accepted image file types are <code class="language-plaintext highlighter-rouge">PNG</code>, <code class="language-plaintext highlighter-rouge">JPG/JPEG</code> and <code class="language-plaintext highlighter-rouge">GIF</code>, with a maximum allowed size of 300kb.
The minimum sticker image resolution is 512x512, and its background SHOULD be transparent.</p>

<h3 id="distribution">Distribution</h3>

<p>The node implements sticker packs as <a href="https://eips.ethereum.org/EIPS/eip-721">ERC721 token</a> and contain a set of stickers. The node stores these stickers
inside the sticker pack as a set of hyperlinks pointing to IPFS storage. These hyperlinks are publicly available and can be accessed by any user inside the status chat.
Stickers can be sent in chat only by accounts that own the sticker pack.</p>

<h3 id="ipfs-gateway">IPFS gateway</h3>
<p>At the moment of writing, the current main Status app uses the <a href="https://infura.io/">Infura</a> gateway. However, clients could choose a different gateway or to run own IPFS node.
Infura gateway is an HTTPS gateway, which based on an HTTP GET request with the multihash block will return the stored content at that block address.</p>

<p>The node requires the use of a gateway to enable easy access to the resources over HTTP.
The node stores each image of a sticker inside IPFS using a unique address that is 
derived from the hash of the file. This ensures that a file can’t be overridden, and an end-user of the IPFS will receive the same file at a given address.</p>

<h3 id="security">Security</h3>
<p>The IPFS gateway acts as an end-user of the IPFS and allows users of the gateway to access IPFS without connection to the P2P network.
Usage of a gateway introduces potential risk for the users of that gateway provider. In case of a compromise in the security of the provider, meta information such as IP address, User-Agent and other of its users can be leaked.
If the provider servers are unavailable the node loses access through the gateway to the IPFS network.</p>

<h3 id="status-sticker-usage">Status sticker usage</h3>
<p>When the app shows a sticker, the Status app makes an HTTP GET request to IPFS gateway using the hyperlink.</p>

<p>To send a sticker in chat, a user of Status should buy or install a sticker pack.</p>

<p>To be available for installation a Sticker Pack should be submitted to Sticker market by an author.</p>

<h4 id="submit-a-sticker">Submit a sticker</h4>

<p>To submit a sticker pack, the author should upload all assets to IPFS. Then generate a payload including name, author, thumbnail, preview and a list of stickers in the <a href="https://github.com/edn-format/edn">EDN format</a>. Following this structure:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{meta {:name "Sticker pack name"
       :author "Author Name"
       :thumbnail "e30101701220602163b4f56c747333f43775fdcbe4e62d6a3e147b22aaf6097ce0143a6b2373"
       :preview "e30101701220ef54a5354b78ef82e542bd468f58804de71c8ec268da7968a1422909357f2456"
       :stickers [{:hash "e301017012207737b75367b8068e5bdd027d7b71a25138c83e155d1f0c9bc5c48ff158724495"}
       {:hash "e301017012201a9cdea03f27cda1aede7315f79579e160c7b2b6a2eb51a66e47a96f47fe5284"}]}}
</code></pre></div></div>
<p>All asset fields, are contenthash fields as per <a href="https://eips.ethereum.org/EIPS/eip-1577">EIP 1577</a>.
The node also uploads this payload to IPFS, and the node uses the IPFS address in the content field of the Sticker Market contract. See <a href="https://github.com/status-im/sticker-market/blob/651e88e5f38c690e57ecaad47f46b9641b8b1e27/docs/specification.md">Sticker Market spec</a> for a detailed description of the contract.</p>

<h4 id="install-a-sticker-pack">Install a sticker pack</h4>

<p>To install a sticker pack, the node fetches all sticker packs available in Sticker Market. The node needs the following steps to fetch all sticker packs:</p>

<h4 id="1-get-total-number-of-sticker-packs">1. Get total number of sticker packs</h4>
<p>Call <code class="language-plaintext highlighter-rouge">packCount()</code> on the sticker market contract, will return number of sticker pack registered as <code class="language-plaintext highlighter-rouge">uint256</code>.</p>

<h4 id="2-get-sticker-pack-by-id">2. Get sticker pack by id</h4>
<p>ID’s are represented as <code class="language-plaintext highlighter-rouge">uint256</code> and are incremental from <code class="language-plaintext highlighter-rouge">0</code> to total number of sticker packs in the contract, received in the previous step. To get a sticker pack call <code class="language-plaintext highlighter-rouge">getPackData(sticker-pack-id)</code>, the return type is  <code class="language-plaintext highlighter-rouge">["bytes4[]" "address" "bool" "uint256" "uint256" "bytes"]</code> which represents the following fields: <code class="language-plaintext highlighter-rouge">[category owner mintable timestamp price contenthash]</code>. Price is the SNT value in wei set by sticker pack owner. The contenthash is the IPFS address described in the <a href="#submit-a-sticker">submit description</a> above. Other fields specification could be found in <a href="https://github.com/status-im/sticker-market/blob/651e88e5f38c690e57ecaad47f46b9641b8b1e27/docs/specification.md">Sticker Market spec</a></p>

<h5 id="3-get-owned-sticker-packs">3. Get owned sticker packs</h5>
<p>The current Status app fetches owned sticker packs during the open of any sticker view (a screen which shows a sticker pack, or the list of sticker packs).
To get owned packs, get all owned tokens for the current account address, by calling <code class="language-plaintext highlighter-rouge">balanceOf(address)</code> where address is the address for the current account. This method returns a <code class="language-plaintext highlighter-rouge">uint256</code> representing the count of available tokens. Using <code class="language-plaintext highlighter-rouge">tokenOfOwnerByIndex(address,uint256)</code> method, with the address of the user and ID in form of a <code class="language-plaintext highlighter-rouge">uint256</code> which is an incremented int from 0 to the total number of tokens, gives the token id. To get the sticker pack id from a token call<code class="language-plaintext highlighter-rouge">tokenPackId(uint256)</code> where <code class="language-plaintext highlighter-rouge">uint256</code> is the token id. This method will return an <code class="language-plaintext highlighter-rouge">uint256</code> which is the id of the owned sticker pack.</p>

<h5 id="4-buy-a-sticker-pack">4. Buy a sticker pack</h5>
<p>To buy a sticker pack call <code class="language-plaintext highlighter-rouge">approveAndCall(address,uint256,bytes)</code> where <code class="language-plaintext highlighter-rouge">address</code> is the address of buyer,<code class="language-plaintext highlighter-rouge">uint256</code> is the price and third parameters <code class="language-plaintext highlighter-rouge">bytes</code> is the callback  called if approved. In the callback, call <code class="language-plaintext highlighter-rouge">buyToken(uint256,address,uint256)</code>, first parameter is sticker pack id, second buyers address, and the last is the price.</p>

<h2 id="copyright">Copyright</h2>

<p>Copyright and related rights waived via <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.</p>
